<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>GMARK AI Worker</title>
  </head>
  <body>
    <script>
      console.log("ü§ñ [1] AI Worker Script geladen - Starte Initialization");

      // Sofort Heartbeat senden - signalisiere dass wir existieren
      (async () => {
        try {
          console.log("ü§ñ [2] Sende Heartbeat zum Service Worker...");
          
          // Warte kurz damit Chrome bereit ist f√ºr sendMessage
          await new Promise((r) => setTimeout(r, 100));
          
          // Sende Heartbeat √ºber runtime.sendMessage (nicht onMessage)
          chrome.runtime.sendMessage({ type: "WORKER_READY" }, (response) => {
            if (chrome.runtime.lastError) {
              console.warn("‚ö†Ô∏è Heartbeat sendMessage error:", chrome.runtime.lastError);
            } else {
              console.log("ü§ñ [3] Heartbeat gesendet:", response);
            }
          });
        } catch (error) {
          console.error("‚ùå Heartbeat Fehler:", error);
        }
      })();

      // Registriere Message Listener
      console.log("ü§ñ [4] Registriere onMessage Listener...");
      
      let messageListenerRegistered = false;
      
      chrome.runtime.onMessage.addListener((request, sender, sendResponse) => {
        console.log("üì® [5] AI Worker empf√§ngt Message:", request.action);
        messageListenerRegistered = true;

        (async () => {
          try {
            const ai = self.ai || globalThis.ai;
            console.log("üì® [6] AI Object Status:", {
              aiExists: !!ai,
              hasLanguageModel: !!ai?.languageModel,
              hasSummarizer: !!ai?.summarizer,
            });

            switch (request.action) {
              case "checkPromptAPI": {
                console.log("üîç [7] checkPromptAPI handler aufgerufen");
                
                if (!ai?.languageModel) {
                  console.warn("‚ö†Ô∏è AI languageModel nicht verf√ºgbar");
                  sendResponse({
                    success: true,
                    result: {
                      available: false,
                      error: "AI object not found",
                      aiExists: !!ai,
                      languageModelExists: !!ai?.languageModel,
                    },
                  });
                  return;
                }

                console.log("üîç [8] Rufe capabilities() auf...");
                const status = await ai.languageModel.capabilities();
                console.log("üîç [9] Capabilities:", status);
                
                sendResponse({
                  success: true,
                  result: {
                    available: status.available === "readily",
                    status: status.available,
                    defaultTemperature: status.defaultTemperature,
                    defaultTopK: status.defaultTopK,
                    maxTopK: status.maxTopK,
                  },
                });
                break;
              }

              case "classify": {
                console.log("ü§ñ [7] classify handler aufgerufen");
                
                if (!ai?.languageModel) {
                  throw new Error("AI languageModel not available");
                }

                const { bookmark } = request;
                console.log("ü§ñ [8] Erstelle Session...");
                const session = await ai.languageModel.create({
                  temperature: 0.3,
                  topK: 3,
                });

                const prompt = `Classify this bookmark into ONE category:
Title: ${bookmark.title}
URL: ${bookmark.url}
Description: ${bookmark.description || "N/A"}

Categories: Development, Design, Tools, Documentation, Learning, News, Social, Entertainment, Other

Respond with ONLY the category name, nothing else.`;

                console.log("ü§ñ [9] Sende Prompt an AI...");
                const result = await session.prompt(prompt);
                const category = result.trim();

                console.log("ü§ñ [10] Klassifikation fertig:", category);
                sendResponse({
                  success: true,
                  result: {
                    success: true,
                    category: category,
                    confidence: 0.9,
                    method: "ai",
                  },
                });

                session.destroy();
                break;
              }

              case "summarize": {
                console.log("üìù [7] summarize handler aufgerufen");
                
                if (!ai?.summarizer) {
                  throw new Error("AI summarizer not available");
                }

                const { content, title } = request;
                console.log("üìù [8] Erstelle Summarizer-Session...");
                const session = await ai.summarizer.create();
                
                console.log("üìù [9] Starte Summarization...");
                const summary = await session.summarize(content);

                console.log("üìù [10] Zusammenfassung fertig");
                sendResponse({
                  success: true,
                  result: summary,
                });

                session.destroy();
                break;
              }

              default:
                console.warn("‚ö†Ô∏è Unbekannte Action:", request.action);
                sendResponse({
                  success: false,
                  error: `Unknown action: ${request.action}`,
                });
            }
          } catch (error) {
            console.error("‚ùå Handler Fehler:", error);
            sendResponse({
              success: false,
              error: error.message,
            });
          }
        })();

        // Wichtig: true f√ºr async response
        return true;
      });

      console.log("ü§ñ [11] AI Worker Initialization abgeschlossen");
      console.log("ü§ñ ‚úÖ AI Worker bereit f√ºr Messages");
    </script>
  </body>
</html>

        (async () => {
          try {
            const ai = self.ai || globalThis.ai;

            switch (request.action) {
              case "checkPromptAPI": {
                if (!ai?.languageModel) {
                  sendResponse({
                    success: true,
                    result: {
                      available: false,
                      error: "AI object not found",
                      aiExists: !!ai,
                      languageModelExists: !!ai?.languageModel,
                    },
                  });
                  return;
                }

                const status = await ai.languageModel.capabilities();
                sendResponse({
                  success: true,
                  result: {
                    available: status.available === "readily",
                    status: status.available,
                    defaultTemperature: status.defaultTemperature,
                    defaultTopK: status.defaultTopK,
                    maxTopK: status.maxTopK,
                  },
                });
                break;
              }

              case "classify": {
                if (!ai?.languageModel) {
                  throw new Error("AI languageModel not available");
                }

                const { bookmark } = request;
                const session = await ai.languageModel.create({
                  temperature: 0.3,
                  topK: 3,
                });

                const prompt = `Classify this bookmark into ONE category:
Title: ${bookmark.title}
URL: ${bookmark.url}
Description: ${bookmark.description || "N/A"}

Categories: Development, Design, Tools, Documentation, Learning, News, Social, Entertainment, Other

Respond with ONLY the category name, nothing else.`;

                const result = await session.prompt(prompt);
                const category = result.trim();

                sendResponse({
                  success: true,
                  result: {
                    success: true,
                    category: category,
                    confidence: 0.9,
                    method: "ai",
                  },
                });

                session.destroy();
                break;
              }

              case "summarize": {
                if (!ai?.summarizer) {
                  throw new Error("AI summarizer not available");
                }

                const { content, title } = request;
                const session = await ai.summarizer.create();
                const summary = await session.summarize(content);

                sendResponse({
                  success: true,
                  result: summary,
                });

                session.destroy();
                break;
              }

              default:
                sendResponse({
                  success: false,
                  error: `Unknown action: ${request.action}`,
                });
            }
          } catch (error) {
            console.error("‚ùå AI Worker Fehler:", error);
            sendResponse({
              success: false,
              error: error.message,
            });
          }
        })();

        return true; // Async response
      });

      console.log("‚úÖ AI Worker bereit f√ºr Messages");
    </script>
  </body>
</html>
